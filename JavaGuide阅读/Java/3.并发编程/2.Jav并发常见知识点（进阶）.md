##  1.synchronized å…³é”®å­—

### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_1-1-è¯´ä¸€è¯´è‡ªå·±å¯¹äº-synchronized-å…³é”®å­—çš„äº†è§£)1.1.è¯´ä¸€è¯´è‡ªå·±å¯¹äº synchronized å…³é”®å­—çš„äº†è§£

**`synchronized` å…³é”®å­—è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ï¼Œ`synchronized`å…³é”®å­—å¯ä»¥ä¿è¯è¢«å®ƒä¿®é¥°çš„æ–¹æ³•æˆ–è€…ä»£ç å—åœ¨ä»»æ„æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚**

å¦å¤–ï¼Œåœ¨ Java æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œ`synchronized` å±äº **é‡é‡çº§é”**ï¼Œæ•ˆç‡ä½ä¸‹ã€‚

**ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ**

å› ä¸ºç›‘è§†å™¨é”ï¼ˆmonitorï¼‰æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„ `Mutex Lock` æ¥å®ç°çš„ï¼ŒJava çš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¹‹ä¸Šçš„ã€‚å¦‚æœè¦æŒ‚èµ·æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿå¸®å¿™å®Œæˆï¼Œè€Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ—¶éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ã€‚

åº†å¹¸çš„æ˜¯åœ¨ Java 6 ä¹‹å Java å®˜æ–¹å¯¹ä» JVM å±‚é¢å¯¹ `synchronized` è¾ƒå¤§ä¼˜åŒ–ï¼Œæ‰€ä»¥ç°åœ¨çš„ `synchronized` é”æ•ˆç‡ä¹Ÿä¼˜åŒ–å¾—å¾ˆä¸é”™äº†ã€‚JDK1.6 å¯¹é”çš„å®ç°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ã€‚

æ‰€ä»¥ï¼Œä½ ä¼šå‘ç°ç›®å‰çš„è¯ï¼Œä¸è®ºæ˜¯å„ç§å¼€æºæ¡†æ¶è¿˜æ˜¯ JDK æºç éƒ½å¤§é‡ä½¿ç”¨äº† `synchronized` å…³é”®å­—ã€‚

### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_1-2-è¯´è¯´è‡ªå·±æ˜¯æ€ä¹ˆä½¿ç”¨-synchronized-å…³é”®å­—)1.2. è¯´è¯´è‡ªå·±æ˜¯æ€ä¹ˆä½¿ç”¨ synchronized å…³é”®å­—

**synchronized å…³é”®å­—æœ€ä¸»è¦çš„ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š**

**1.ä¿®é¥°å®ä¾‹æ–¹æ³•:** ä½œç”¨äºå½“å‰å¯¹è±¡å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— **å½“å‰å¯¹è±¡å®ä¾‹çš„é”**

```java
synchronized void method() {
    //ä¸šåŠ¡ä»£ç 
}
```

**2.ä¿®é¥°é™æ€æ–¹æ³•:** ä¹Ÿå°±æ˜¯ç»™å½“å‰ç±»åŠ é”ï¼Œä¼šä½œç”¨äºç±»çš„æ‰€æœ‰å¯¹è±¡å®ä¾‹ ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— **å½“å‰ class çš„é”**ã€‚å› ä¸ºé™æ€æˆå‘˜ä¸å±äºä»»ä½•ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œæ˜¯ç±»æˆå‘˜ï¼ˆ *static è¡¨æ˜è¿™æ˜¯è¯¥ç±»çš„ä¸€ä¸ªé™æ€èµ„æºï¼Œä¸ç®¡ new äº†å¤šå°‘ä¸ªå¯¹è±¡ï¼Œåªæœ‰ä¸€ä»½*ï¼‰ã€‚æ‰€ä»¥ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹ A è°ƒç”¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éé™æ€ `synchronized` æ–¹æ³•ï¼Œè€Œçº¿ç¨‹ B éœ€è¦è°ƒç”¨è¿™ä¸ªå®ä¾‹å¯¹è±¡æ‰€å±ç±»çš„é™æ€ `synchronized` æ–¹æ³•ï¼Œæ˜¯å…è®¸çš„ï¼Œä¸ä¼šå‘ç”Ÿäº’æ–¥ç°è±¡ï¼Œ**å› ä¸ºè®¿é—®é™æ€ `synchronized` æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰ç±»çš„é”ï¼Œè€Œè®¿é—®éé™æ€ `synchronized` æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡é”**ã€‚

```java
synchronized static void method() {
    //ä¸šåŠ¡ä»£ç 
}
```

**3.ä¿®é¥°ä»£ç å—** ï¼šæŒ‡å®šåŠ é”å¯¹è±¡ï¼Œå¯¹ç»™å®šå¯¹è±¡/ç±»åŠ é”ã€‚`synchronized(this|object)` è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç åº“å‰è¦è·å¾—**ç»™å®šå¯¹è±¡çš„é”**ã€‚`synchronized(ç±».class)` è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— **å½“å‰ class çš„é”**

```java
synchronized(this) {
    //ä¸šåŠ¡ä»£ç 
}
```

**æ€»ç»“ï¼š**

- `synchronized` å…³é”®å­—åŠ åˆ° `static` é™æ€æ–¹æ³•å’Œ `synchronized(class)` ä»£ç å—ä¸Šéƒ½æ˜¯æ˜¯ç»™ Class ç±»ä¸Šé”ã€‚
- `synchronized` å…³é”®å­—åŠ åˆ°å®ä¾‹æ–¹æ³•ä¸Šæ˜¯ç»™å¯¹è±¡å®ä¾‹ä¸Šé”ã€‚
- å°½é‡ä¸è¦ä½¿ç”¨ `synchronized(String a)` å› ä¸º JVM ä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å…·æœ‰ç¼“å­˜åŠŸèƒ½ï¼

ä¸‹é¢æˆ‘ä»¥ä¸€ä¸ªå¸¸è§çš„é¢è¯•é¢˜ä¸ºä¾‹è®²è§£ä¸€ä¸‹ `synchronized` å…³é”®å­—çš„å…·ä½“ä½¿ç”¨ã€‚

é¢è¯•ä¸­é¢è¯•å®˜ç»å¸¸ä¼šè¯´ï¼šâ€œå•ä¾‹æ¨¡å¼äº†è§£å—ï¼Ÿæ¥ç»™æˆ‘æ‰‹å†™ä¸€ä¸‹ï¼ç»™æˆ‘è§£é‡Šä¸€ä¸‹åŒé‡æ£€éªŒé”æ–¹å¼å®ç°å•ä¾‹æ¨¡å¼çš„åŸç†å‘—ï¼â€

**åŒé‡æ ¡éªŒé”å®ç°å¯¹è±¡å•ä¾‹ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰**

```java
public class Singleton {

    private volatile static Singleton uniqueInstance;

    private Singleton() {
    }

    public  static Singleton getUniqueInstance() {
       //å…ˆåˆ¤æ–­å¯¹è±¡æ˜¯å¦å·²ç»å®ä¾‹è¿‡ï¼Œæ²¡æœ‰å®ä¾‹åŒ–è¿‡æ‰è¿›å…¥åŠ é”ä»£ç 
        if (uniqueInstance == null) {
            //ç±»å¯¹è±¡åŠ é”
            synchronized (Singleton.class) {
                if (uniqueInstance == null) {
                    uniqueInstance = new Singleton();
                }
            }
        }
        return uniqueInstance;
    }
}
```

å¦å¤–ï¼Œéœ€è¦æ³¨æ„ `uniqueInstance` é‡‡ç”¨ `volatile` å…³é”®å­—ä¿®é¥°ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦ã€‚

`uniqueInstance` é‡‡ç”¨ `volatile` å…³é”®å­—ä¿®é¥°ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œ `uniqueInstance = new Singleton();` è¿™æ®µä»£ç å…¶å®æ˜¯åˆ†ä¸ºä¸‰æ­¥æ‰§è¡Œï¼š

1. ä¸º `uniqueInstance` åˆ†é…å†…å­˜ç©ºé—´
2. åˆå§‹åŒ– `uniqueInstance`
3. å°† `uniqueInstance` æŒ‡å‘åˆ†é…çš„å†…å­˜åœ°å€

ä½†æ˜¯ç”±äº JVM å…·æœ‰æŒ‡ä»¤é‡æ’çš„ç‰¹æ€§ï¼Œæ‰§è¡Œé¡ºåºæœ‰å¯èƒ½å˜æˆ 1->3->2ã€‚æŒ‡ä»¤é‡æ’åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šå¯¼è‡´ä¸€ä¸ªçº¿ç¨‹è·å¾—è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œçº¿ç¨‹ T1 æ‰§è¡Œäº† 1 å’Œ 3ï¼Œæ­¤æ—¶ T2 è°ƒç”¨ `getUniqueInstance`() åå‘ç° `uniqueInstance` ä¸ä¸ºç©ºï¼Œå› æ­¤è¿”å› `uniqueInstance`ï¼Œä½†æ­¤æ—¶ `uniqueInstance` è¿˜æœªè¢«åˆå§‹åŒ–ã€‚

ä½¿ç”¨ `volatile` å¯ä»¥ç¦æ­¢ JVM çš„æŒ‡ä»¤é‡æ’ï¼Œä¿è¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚

### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_1-3-æ„é€ æ–¹æ³•å¯ä»¥ä½¿ç”¨-synchronized-å…³é”®å­—ä¿®é¥°ä¹ˆ)1.3. æ„é€ æ–¹æ³•å¯ä»¥ä½¿ç”¨ synchronized å…³é”®å­—ä¿®é¥°ä¹ˆï¼Ÿ

å…ˆè¯´ç»“è®ºï¼š**æ„é€ æ–¹æ³•ä¸èƒ½ä½¿ç”¨ synchronized å…³é”®å­—ä¿®é¥°ã€‚**

æ„é€ æ–¹æ³•æœ¬èº«å°±å±äºçº¿ç¨‹å®‰å…¨çš„ï¼Œä¸å­˜åœ¨åŒæ­¥çš„æ„é€ æ–¹æ³•ä¸€è¯´ã€‚

### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_1-3-è®²ä¸€ä¸‹-synchronized-å…³é”®å­—çš„åº•å±‚åŸç†)1.3. è®²ä¸€ä¸‹ synchronized å…³é”®å­—çš„åº•å±‚åŸç†

**synchronized å…³é”®å­—åº•å±‚åŸç†å±äº JVM å±‚é¢ã€‚**

#### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_1-3-1-synchronized-åŒæ­¥è¯­å¥å—çš„æƒ…å†µ)1.3.1. synchronized åŒæ­¥è¯­å¥å—çš„æƒ…å†µ

```java
public class SynchronizedDemo {
    public void method() {
        synchronized (this) {
            System.out.println("synchronized ä»£ç å—");
        }
    }
}
```

é€šè¿‡ JDK è‡ªå¸¦çš„ `javap` å‘½ä»¤æŸ¥çœ‹ `SynchronizedDemo` ç±»çš„ç›¸å…³å­—èŠ‚ç ä¿¡æ¯ï¼šé¦–å…ˆåˆ‡æ¢åˆ°ç±»çš„å¯¹åº”ç›®å½•æ‰§è¡Œ `javac SynchronizedDemo.java` å‘½ä»¤ç”Ÿæˆç¼–è¯‘åçš„ .class æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œ`javap -c -s -v -l SynchronizedDemo.class`ã€‚

![synchronizedå…³é”®å­—åŸç†](https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E5%8E%9F%E7%90%86.png)

ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š**`synchronized` åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚**

å½“æ‰§è¡Œ `monitorenter` æŒ‡ä»¤æ—¶ï¼Œçº¿ç¨‹è¯•å›¾è·å–é”ä¹Ÿå°±æ˜¯è·å– **å¯¹è±¡ç›‘è§†å™¨ `monitor`** çš„æŒæœ‰æƒã€‚

> åœ¨ Java è™šæ‹Ÿæœº(HotSpot)ä¸­ï¼ŒMonitor æ˜¯åŸºäº C++å®ç°çš„ï¼Œç”±[ObjectMonitoropen in new window](https://github.com/openjdk-mirror/jdk7u-hotspot/blob/50bdefc3afe944ca74c3093e7448d6b889cd20d1/src/share/vm/runtime/objectMonitor.cpp)å®ç°çš„ã€‚æ¯ä¸ªå¯¹è±¡ä¸­éƒ½å†…ç½®äº†ä¸€ä¸ª `ObjectMonitor`å¯¹è±¡ã€‚
>
> å¦å¤–ï¼Œ`wait/notify`ç­‰æ–¹æ³•ä¹Ÿä¾èµ–äº`monitor`å¯¹è±¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåªæœ‰åœ¨åŒæ­¥çš„å—æˆ–è€…æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨`wait/notify`ç­‰æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡º`java.lang.IllegalMonitorStateException`çš„å¼‚å¸¸çš„åŸå› ã€‚

åœ¨æ‰§è¡Œ`monitorenter`æ—¶ï¼Œä¼šå°è¯•è·å–å¯¹è±¡çš„é”ï¼Œå¦‚æœé”çš„è®¡æ•°å™¨ä¸º 0 åˆ™è¡¨ç¤ºé”å¯ä»¥è¢«è·å–ï¼Œè·å–åå°†é”è®¡æ•°å™¨è®¾ä¸º 1 ä¹Ÿå°±æ˜¯åŠ  1ã€‚

![æ‰§è¡Œ monitorenter è·å–é”](https://javaguide.cn/assets/synchronized-get-lock-code-block.f8021972.png)

å¯¹è±¡é”çš„çš„æ‹¥æœ‰è€…çº¿ç¨‹æ‰å¯ä»¥æ‰§è¡Œ `monitorexit` æŒ‡ä»¤æ¥é‡Šæ”¾é”ã€‚åœ¨æ‰§è¡Œ `monitorexit` æŒ‡ä»¤åï¼Œå°†é”è®¡æ•°å™¨è®¾ä¸º 0ï¼Œè¡¨æ˜é”è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥å°è¯•è·å–é”ã€‚

![æ‰§è¡Œ monitorexit é‡Šæ”¾é”](https://javaguide.cn/assets/synchronized-release-lock-block.c8310368.png)

å¦‚æœè·å–å¯¹è±¡é”å¤±è´¥ï¼Œé‚£å½“å‰çº¿ç¨‹å°±è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é”è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ä¸ºæ­¢ã€‚

#### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_1-3-2-synchronized-ä¿®é¥°æ–¹æ³•çš„çš„æƒ…å†µ)1.3.2. synchronized ä¿®é¥°æ–¹æ³•çš„çš„æƒ…å†µ

```java
public class SynchronizedDemo2 {
    public synchronized void method() {
        System.out.println("synchronized æ–¹æ³•");
    }
}
```

![synchronizedå…³é”®å­—åŸç†](https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E5%8E%9F%E7%90%862.png)

`synchronized` ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ `monitorenter` æŒ‡ä»¤å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå–å¾—ä»£ä¹‹çš„ç¡®å®æ˜¯ `ACC_SYNCHRONIZED` æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚JVM é€šè¿‡è¯¥ `ACC_SYNCHRONIZED` è®¿é—®æ ‡å¿—æ¥è¾¨åˆ«ä¸€ä¸ªæ–¹æ³•æ˜¯å¦å£°æ˜ä¸ºåŒæ­¥æ–¹æ³•ï¼Œä»è€Œæ‰§è¡Œç›¸åº”çš„åŒæ­¥è°ƒç”¨ã€‚

å¦‚æœæ˜¯å®ä¾‹æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å®ä¾‹å¯¹è±¡çš„é”ã€‚å¦‚æœæ˜¯é™æ€æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å½“å‰ class çš„é”ã€‚

#### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_1-3-3-æ€»ç»“)1.3.3.æ€»ç»“

`synchronized` åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚

`synchronized` ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ `monitorenter` æŒ‡ä»¤å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå–å¾—ä»£ä¹‹çš„ç¡®å®æ˜¯ `ACC_SYNCHRONIZED` æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚

**ä¸è¿‡ä¸¤è€…çš„æœ¬è´¨éƒ½æ˜¯å¯¹å¯¹è±¡ç›‘è§†å™¨ monitor çš„è·å–ã€‚**

ç›¸å…³æ¨èï¼š[Javaé”ä¸çº¿ç¨‹çš„é‚£äº›äº‹ - æœ‰èµæŠ€æœ¯å›¢é˜Ÿopen in new window](https://tech.youzan.com/javasuo-yu-xian-cheng-de-na-xie-shi/) ã€‚

ğŸ§—ğŸ»è¿›é˜¶ä¸€ä¸‹ï¼šå­¦æœ‰ä½™åŠ›çš„å°ä¼™ä¼´å¯ä»¥æŠ½æ—¶é—´è¯¦ç»†ç ”ç©¶ä¸€ä¸‹å¯¹è±¡ç›‘è§†å™¨ `monitor`ã€‚

### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_1-4-è¯´è¯´-jdk1-6-ä¹‹åçš„-synchronized-å…³é”®å­—åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–-å¯ä»¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™äº›ä¼˜åŒ–å—)1.4. è¯´è¯´ JDK1.6 ä¹‹åçš„ synchronized å…³é”®å­—åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–ï¼Œå¯ä»¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™äº›ä¼˜åŒ–å—

JDK1.6 å¯¹é”çš„å®ç°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚åå‘é”ã€è½»é‡çº§é”ã€è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ã€‚

é”ä¸»è¦å­˜åœ¨å››ç§çŠ¶æ€ï¼Œä¾æ¬¡æ˜¯ï¼šæ— é”çŠ¶æ€ã€åå‘é”çŠ¶æ€ã€è½»é‡çº§é”çŠ¶æ€ã€é‡é‡çº§é”çŠ¶æ€ï¼Œä»–ä»¬ä¼šéšç€ç«äº‰çš„æ¿€çƒˆè€Œé€æ¸å‡çº§ã€‚æ³¨æ„é”å¯ä»¥å‡çº§ä¸å¯é™çº§ï¼Œè¿™ç§ç­–ç•¥æ˜¯ä¸ºäº†æé«˜è·å¾—é”å’Œé‡Šæ”¾é”çš„æ•ˆç‡ã€‚

å…³äºè¿™å‡ ç§ä¼˜åŒ–çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥æŸ¥çœ‹ä¸‹é¢è¿™ç¯‡æ–‡ç« ï¼š[Java6 åŠä»¥ä¸Šç‰ˆæœ¬å¯¹ synchronized çš„ä¼˜åŒ–open in new window](https://www.cnblogs.com/wuqinglong/p/9945618.html)

### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_1-5-è°ˆè°ˆ-synchronized-å’Œ-reentrantlock-çš„åŒºåˆ«)1.5. è°ˆè°ˆ synchronized å’Œ ReentrantLock çš„åŒºåˆ«

#### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_1-5-1-ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”)1.5.1. ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”

**â€œå¯é‡å…¥é”â€** æŒ‡çš„æ˜¯è‡ªå·±å¯ä»¥å†æ¬¡è·å–è‡ªå·±çš„å†…éƒ¨é”ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†æŸä¸ªå¯¹è±¡çš„é”ï¼Œæ­¤æ—¶è¿™ä¸ªå¯¹è±¡é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå½“å…¶å†æ¬¡æƒ³è¦è·å–è¿™ä¸ªå¯¹è±¡çš„é”çš„æ—¶å€™è¿˜æ˜¯å¯ä»¥è·å–çš„ï¼Œå¦‚æœæ˜¯ä¸å¯é‡å…¥é”çš„è¯ï¼Œå°±ä¼šé€ æˆæ­»é”ã€‚åŒä¸€ä¸ªçº¿ç¨‹æ¯æ¬¡è·å–é”ï¼Œé”çš„è®¡æ•°å™¨éƒ½è‡ªå¢ 1ï¼Œæ‰€ä»¥è¦ç­‰åˆ°é”çš„è®¡æ•°å™¨ä¸‹é™ä¸º 0 æ—¶æ‰èƒ½é‡Šæ”¾é”ã€‚

#### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_1-5-2-synchronized-ä¾èµ–äº-jvm-è€Œ-reentrantlock-ä¾èµ–äº-api)1.5.2.synchronized ä¾èµ–äº JVM è€Œ ReentrantLock ä¾èµ–äº API

`synchronized` æ˜¯ä¾èµ–äº JVM å®ç°çš„ï¼Œå‰é¢æˆ‘ä»¬ä¹Ÿè®²åˆ°äº† è™šæ‹Ÿæœºå›¢é˜Ÿåœ¨ JDK1.6 ä¸º `synchronized` å…³é”®å­—è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œä½†æ˜¯è¿™äº›ä¼˜åŒ–éƒ½æ˜¯åœ¨è™šæ‹Ÿæœºå±‚é¢å®ç°çš„ï¼Œå¹¶æ²¡æœ‰ç›´æ¥æš´éœ²ç»™æˆ‘ä»¬ã€‚`ReentrantLock` æ˜¯ JDK å±‚é¢å®ç°çš„ï¼ˆä¹Ÿå°±æ˜¯ API å±‚é¢ï¼Œéœ€è¦ lock() å’Œ unlock() æ–¹æ³•é…åˆ try/finally è¯­å¥å—æ¥å®Œæˆï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹å®ƒçš„æºä»£ç ï¼Œæ¥çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚

#### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_1-5-3-reentrantlock-æ¯”-synchronized-å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½)1.5.3.ReentrantLock æ¯” synchronized å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½

ç›¸æ¯”`synchronized`ï¼Œ`ReentrantLock`å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½ã€‚ä¸»è¦æ¥è¯´ä¸»è¦æœ‰ä¸‰ç‚¹ï¼š

- **ç­‰å¾…å¯ä¸­æ–­** : `ReentrantLock`æä¾›äº†ä¸€ç§èƒ½å¤Ÿä¸­æ–­ç­‰å¾…é”çš„çº¿ç¨‹çš„æœºåˆ¶ï¼Œé€šè¿‡ `lock.lockInterruptibly()` æ¥å®ç°è¿™ä¸ªæœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…ã€‚
- **å¯å®ç°å…¬å¹³é”** : `ReentrantLock`å¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚è€Œ`synchronized`åªèƒ½æ˜¯éå…¬å¹³é”ã€‚æ‰€è°“çš„å…¬å¹³é”å°±æ˜¯å…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆè·å¾—é”ã€‚`ReentrantLock`é»˜è®¤æƒ…å†µæ˜¯éå…¬å¹³çš„ï¼Œå¯ä»¥é€šè¿‡ `ReentrantLock`ç±»çš„`ReentrantLock(boolean fair)`æ„é€ æ–¹æ³•æ¥åˆ¶å®šæ˜¯å¦æ˜¯å…¬å¹³çš„ã€‚
- **å¯å®ç°é€‰æ‹©æ€§é€šçŸ¥ï¼ˆé”å¯ä»¥ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼‰**: `synchronized`å…³é”®å­—ä¸`wait()`å’Œ`notify()`/`notifyAll()`æ–¹æ³•ç›¸ç»“åˆå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚`ReentrantLock`ç±»å½“ç„¶ä¹Ÿå¯ä»¥å®ç°ï¼Œä½†æ˜¯éœ€è¦å€ŸåŠ©äº`Condition`æ¥å£ä¸`newCondition()`æ–¹æ³•ã€‚

> `Condition`æ˜¯ JDK1.5 ä¹‹åæ‰æœ‰çš„ï¼Œå®ƒå…·æœ‰å¾ˆå¥½çš„çµæ´»æ€§ï¼Œæ¯”å¦‚å¯ä»¥å®ç°å¤šè·¯é€šçŸ¥åŠŸèƒ½ä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ª`Lock`å¯¹è±¡ä¸­å¯ä»¥åˆ›å»ºå¤šä¸ª`Condition`å®ä¾‹ï¼ˆå³å¯¹è±¡ç›‘è§†å™¨ï¼‰ï¼Œ**çº¿ç¨‹å¯¹è±¡å¯ä»¥æ³¨å†Œåœ¨æŒ‡å®šçš„`Condition`ä¸­ï¼Œä»è€Œå¯ä»¥æœ‰é€‰æ‹©æ€§çš„è¿›è¡Œçº¿ç¨‹é€šçŸ¥ï¼Œåœ¨è°ƒåº¦çº¿ç¨‹ä¸Šæ›´åŠ çµæ´»ã€‚ åœ¨ä½¿ç”¨`notify()/notifyAll()`æ–¹æ³•è¿›è¡Œé€šçŸ¥æ—¶ï¼Œè¢«é€šçŸ¥çš„çº¿ç¨‹æ˜¯ç”± JVM é€‰æ‹©çš„ï¼Œç”¨`ReentrantLock`ç±»ç»“åˆ`Condition`å®ä¾‹å¯ä»¥å®ç°â€œé€‰æ‹©æ€§é€šçŸ¥â€** ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸é‡è¦ï¼Œè€Œä¸”æ˜¯ Condition æ¥å£é»˜è®¤æä¾›çš„ã€‚è€Œ`synchronized`å…³é”®å­—å°±ç›¸å½“äºæ•´ä¸ª Lock å¯¹è±¡ä¸­åªæœ‰ä¸€ä¸ª`Condition`å®ä¾‹ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ³¨å†Œåœ¨å®ƒä¸€ä¸ªèº«ä¸Šã€‚å¦‚æœæ‰§è¡Œ`notifyAll()`æ–¹æ³•çš„è¯å°±ä¼šé€šçŸ¥æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹è¿™æ ·ä¼šé€ æˆå¾ˆå¤§çš„æ•ˆç‡é—®é¢˜ï¼Œè€Œ`Condition`å®ä¾‹çš„`signalAll()`æ–¹æ³• åªä¼šå”¤é†’æ³¨å†Œåœ¨è¯¥`Condition`å®ä¾‹ä¸­çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚

**å¦‚æœä½ æƒ³ä½¿ç”¨ä¸Šè¿°åŠŸèƒ½ï¼Œé‚£ä¹ˆé€‰æ‹© ReentrantLock æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚æ€§èƒ½å·²ä¸æ˜¯é€‰æ‹©æ ‡å‡†**

## [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_2-volatile-å…³é”®å­—)2. volatile å…³é”®å­—

æˆ‘ä»¬å…ˆè¦ä» **CPU ç¼“å­˜æ¨¡å‹** è¯´èµ·ï¼

### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_2-1-cpu-ç¼“å­˜æ¨¡å‹)2.1. CPU ç¼“å­˜æ¨¡å‹

**ä¸ºä»€ä¹ˆè¦å¼„ä¸€ä¸ª CPU é«˜é€Ÿç¼“å­˜å‘¢ï¼Ÿ**

ç±»æ¯”æˆ‘ä»¬å¼€å‘ç½‘ç«™åå°ç³»ç»Ÿä½¿ç”¨çš„ç¼“å­˜ï¼ˆæ¯”å¦‚ Redisï¼‰æ˜¯ä¸ºäº†è§£å†³ç¨‹åºå¤„ç†é€Ÿåº¦å’Œè®¿é—®å¸¸è§„å…³ç³»å‹æ•°æ®åº“é€Ÿåº¦ä¸å¯¹ç­‰çš„é—®é¢˜ã€‚ **CPU ç¼“å­˜åˆ™æ˜¯ä¸ºäº†è§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜å¤„ç†é€Ÿåº¦ä¸å¯¹ç­‰çš„é—®é¢˜ã€‚**

æˆ‘ä»¬ç”šè‡³å¯ä»¥æŠŠ **å†…å­˜å¯ä»¥çœ‹ä½œå¤–å­˜çš„é«˜é€Ÿç¼“å­˜**ï¼Œç¨‹åºè¿è¡Œçš„æ—¶å€™æˆ‘ä»¬æŠŠå¤–å­˜çš„æ•°æ®å¤åˆ¶åˆ°å†…å­˜ï¼Œç”±äºå†…å­˜çš„å¤„ç†é€Ÿåº¦è¿œè¿œé«˜äºå¤–å­˜ï¼Œè¿™æ ·æé«˜äº†å¤„ç†é€Ÿåº¦ã€‚

æ€»ç»“ï¼š**CPU Cache ç¼“å­˜çš„æ˜¯å†…å­˜æ•°æ®ç”¨äºè§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜ä¸åŒ¹é…çš„é—®é¢˜ï¼Œå†…å­˜ç¼“å­˜çš„æ˜¯ç¡¬ç›˜æ•°æ®ç”¨äºè§£å†³ç¡¬ç›˜è®¿é—®é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜ã€‚**

ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œæˆ‘ç”»äº†ä¸€ä¸ªç®€å•çš„ CPU Cache ç¤ºæ„å›¾å¦‚ä¸‹ï¼ˆå®é™…ä¸Šï¼Œç°ä»£çš„ CPU Cache é€šå¸¸åˆ†ä¸ºä¸‰å±‚ï¼Œåˆ†åˆ«å« L1,L2,L3 Cacheï¼‰:

![cpu-cache](https://javaguide.cn/assets/cpu-cache.7bd155ca.png)

**CPU Cache çš„å·¥ä½œæ–¹å¼ï¼š**

å…ˆå¤åˆ¶ä¸€ä»½æ•°æ®åˆ° CPU Cache ä¸­ï¼Œå½“ CPU éœ€è¦ç”¨åˆ°çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ä» CPU Cache ä¸­è¯»å–æ•°æ®ï¼Œå½“è¿ç®—å®Œæˆåï¼Œå†å°†è¿ç®—å¾—åˆ°çš„æ•°æ®å†™å› Main Memory ä¸­ã€‚ä½†æ˜¯ï¼Œè¿™æ ·å­˜åœ¨ **å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§çš„é—®é¢˜** ï¼æ¯”å¦‚æˆ‘æ‰§è¡Œä¸€ä¸ª i++æ“ä½œçš„è¯ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œçš„è¯ï¼Œå‡è®¾ä¸¤ä¸ªçº¿ç¨‹ä» CPU Cache ä¸­è¯»å–çš„ i=1ï¼Œä¸¤ä¸ªçº¿ç¨‹åšäº† 1++è¿ç®—å®Œä¹‹åå†å†™å› Main Memory ä¹‹å i=2ï¼Œè€Œæ­£ç¡®ç»“æœåº”è¯¥æ˜¯ i=3ã€‚

**CPU ä¸ºäº†è§£å†³å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜å¯ä»¥é€šè¿‡åˆ¶å®šç¼“å­˜ä¸€è‡´åè®®æˆ–è€…å…¶ä»–æ‰‹æ®µæ¥è§£å†³ã€‚**

## 3. ThreadLocal

### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_3-1-threadlocal-ç®€ä»‹)3.1. ThreadLocal ç®€ä»‹

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºçš„å˜é‡æ˜¯å¯ä»¥è¢«ä»»ä½•ä¸€ä¸ªçº¿ç¨‹è®¿é—®å¹¶ä¿®æ”¹çš„ã€‚**å¦‚æœæƒ³å®ç°æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸“å±æœ¬åœ°å˜é‡è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ** JDK ä¸­æä¾›çš„`ThreadLocal`ç±»æ­£æ˜¯ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚ **`ThreadLocal`ç±»ä¸»è¦è§£å†³çš„å°±æ˜¯è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œå¯ä»¥å°†`ThreadLocal`ç±»å½¢è±¡çš„æ¯”å–»æˆå­˜æ”¾æ•°æ®çš„ç›’å­ï¼Œç›’å­ä¸­å¯ä»¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚**

**å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ª`ThreadLocal`å˜é‡ï¼Œé‚£ä¹ˆè®¿é—®è¿™ä¸ªå˜é‡çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¿™ä¸ªå˜é‡çš„æœ¬åœ°å‰¯æœ¬ï¼Œè¿™ä¹Ÿæ˜¯`ThreadLocal`å˜é‡åçš„ç”±æ¥ã€‚ä»–ä»¬å¯ä»¥ä½¿ç”¨ `getï¼ˆï¼‰` å’Œ `setï¼ˆï¼‰` æ–¹æ³•æ¥è·å–é»˜è®¤å€¼æˆ–å°†å…¶å€¼æ›´æ”¹ä¸ºå½“å‰çº¿ç¨‹æ‰€å­˜çš„å‰¯æœ¬çš„å€¼ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚**

å†ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š

æ¯”å¦‚æœ‰ä¸¤ä¸ªäººå»å®å±‹æ”¶é›†å®ç‰©ï¼Œè¿™ä¸¤ä¸ªå…±ç”¨ä¸€ä¸ªè¢‹å­çš„è¯è‚¯å®šä¼šäº§ç”Ÿäº‰æ‰§ï¼Œä½†æ˜¯ç»™ä»–ä»¬ä¸¤ä¸ªäººæ¯ä¸ªäººåˆ†é…ä¸€ä¸ªè¢‹å­çš„è¯å°±ä¸ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ã€‚å¦‚æœæŠŠè¿™ä¸¤ä¸ªäººæ¯”ä½œçº¿ç¨‹çš„è¯ï¼Œé‚£ä¹ˆ ThreadLocal å°±æ˜¯ç”¨æ¥é¿å…è¿™ä¸¤ä¸ªçº¿ç¨‹ç«äº‰çš„ã€‚

### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_3-2-threadlocal-ç¤ºä¾‹)3.2. ThreadLocal ç¤ºä¾‹

ç›¸ä¿¡çœ‹äº†ä¸Šé¢çš„è§£é‡Šï¼Œå¤§å®¶å·²ç»ææ‡‚ ThreadLocal ç±»æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿äº†ã€‚

```java
import java.text.SimpleDateFormat;
import java.util.Random;

public class ThreadLocalExample implements Runnable{

     // SimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æ¯ä¸ªçº¿ç¨‹éƒ½è¦æœ‰è‡ªå·±ç‹¬ç«‹çš„å‰¯æœ¬
    private static final ThreadLocal<SimpleDateFormat> formatter = ThreadLocal.withInitial(() -> new SimpleDateFormat("yyyyMMdd HHmm"));

    public static void main(String[] args) throws InterruptedException {
        ThreadLocalExample obj = new ThreadLocalExample();
        for(int i=0 ; i<10; i++){
            Thread t = new Thread(obj, ""+i);
            Thread.sleep(new Random().nextInt(1000));
            t.start();
        }
    }

    @Override
    public void run() {
        System.out.println("Thread Name= "+Thread.currentThread().getName()+" default Formatter = "+formatter.get().toPattern());
        try {
            Thread.sleep(new Random().nextInt(1000));
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        //formatter pattern is changed here by thread, but it won't reflect to other threads
        formatter.set(new SimpleDateFormat());

        System.out.println("Thread Name= "+Thread.currentThread().getName()+" formatter = "+formatter.get().toPattern());
    }

}
```

Output:

```text
Thread Name= 0 default Formatter = yyyyMMdd HHmm
Thread Name= 0 formatter = yy-M-d ah:mm
Thread Name= 1 default Formatter = yyyyMMdd HHmm
Thread Name= 2 default Formatter = yyyyMMdd HHmm
Thread Name= 1 formatter = yy-M-d ah:mm
Thread Name= 3 default Formatter = yyyyMMdd HHmm
Thread Name= 2 formatter = yy-M-d ah:mm
Thread Name= 4 default Formatter = yyyyMMdd HHmm
Thread Name= 3 formatter = yy-M-d ah:mm
Thread Name= 4 formatter = yy-M-d ah:mm
Thread Name= 5 default Formatter = yyyyMMdd HHmm
Thread Name= 5 formatter = yy-M-d ah:mm
Thread Name= 6 default Formatter = yyyyMMdd HHmm
Thread Name= 6 formatter = yy-M-d ah:mm
Thread Name= 7 default Formatter = yyyyMMdd HHmm
Thread Name= 7 formatter = yy-M-d ah:mm
Thread Name= 8 default Formatter = yyyyMMdd HHmm
Thread Name= 9 default Formatter = yyyyMMdd HHmm
Thread Name= 8 formatter = yy-M-d ah:mm
Thread Name= 9 formatter = yy-M-d ah:mm
```

ä»è¾“å‡ºä¸­å¯ä»¥çœ‹å‡ºï¼ŒThread-0 å·²ç»æ”¹å˜äº† formatter çš„å€¼ï¼Œä½†ä»ç„¶æ˜¯ thread-2 é»˜è®¤æ ¼å¼åŒ–ç¨‹åºä¸åˆå§‹åŒ–å€¼ç›¸åŒï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿä¸€æ ·ã€‚

ä¸Šé¢æœ‰ä¸€æ®µä»£ç ç”¨åˆ°äº†åˆ›å»º `ThreadLocal` å˜é‡çš„é‚£æ®µä»£ç ç”¨åˆ°äº† Java8 çš„çŸ¥è¯†ï¼Œå®ƒç­‰äºä¸‹é¢è¿™æ®µä»£ç ï¼Œå¦‚æœä½ å†™äº†ä¸‹é¢è¿™æ®µä»£ç çš„è¯ï¼ŒIDEA ä¼šæç¤ºä½ è½¬æ¢ä¸º Java8 çš„æ ¼å¼(IDEA çœŸçš„ä¸é”™ï¼)ã€‚å› ä¸º ThreadLocal ç±»åœ¨ Java 8 ä¸­æ‰©å±•ï¼Œä½¿ç”¨ä¸€ä¸ªæ–°çš„æ–¹æ³•`withInitial()`ï¼Œå°† Supplier åŠŸèƒ½æ¥å£ä½œä¸ºå‚æ•°ã€‚

```java
private static final ThreadLocal<SimpleDateFormat> formatter = new ThreadLocal<SimpleDateFormat>(){
    @Override
    protected SimpleDateFormat initialValue(){
        return new SimpleDateFormat("yyyyMMdd HHmm");
    }
};
```

### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_3-3-threadlocal-åŸç†)3.3. ThreadLocal åŸç†

ä» `Thread`ç±»æºä»£ç å…¥æ‰‹ã€‚

```java
public class Thread implements Runnable {
    //......
    //ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„ThreadLocalå€¼ã€‚ç”±ThreadLocalç±»ç»´æŠ¤
    ThreadLocal.ThreadLocalMap threadLocals = null;

    //ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„InheritableThreadLocalå€¼ã€‚ç”±InheritableThreadLocalç±»ç»´æŠ¤
    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
    //......
}
```

ä»ä¸Šé¢`Thread`ç±» æºä»£ç å¯ä»¥çœ‹å‡º`Thread` ç±»ä¸­æœ‰ä¸€ä¸ª `threadLocals` å’Œ ä¸€ä¸ª `inheritableThreadLocals` å˜é‡ï¼Œå®ƒä»¬éƒ½æ˜¯ `ThreadLocalMap` ç±»å‹çš„å˜é‡,æˆ‘ä»¬å¯ä»¥æŠŠ `ThreadLocalMap` ç†è§£ä¸º`ThreadLocal` ç±»å®ç°çš„å®šåˆ¶åŒ–çš„ `HashMap`ã€‚é»˜è®¤æƒ…å†µä¸‹è¿™ä¸¤ä¸ªå˜é‡éƒ½æ˜¯ nullï¼Œåªæœ‰å½“å‰çº¿ç¨‹è°ƒç”¨ `ThreadLocal` ç±»çš„ `set`æˆ–`get`æ–¹æ³•æ—¶æ‰åˆ›å»ºå®ƒä»¬ï¼Œå®é™…ä¸Šè°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯`ThreadLocalMap`ç±»å¯¹åº”çš„ `get()`ã€`set()`æ–¹æ³•ã€‚

`ThreadLocal`ç±»çš„`set()`æ–¹æ³•

```java
public void set(T value) {
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null)
        map.set(this, value);
    else
        createMap(t, value);
}
ThreadLocalMap getMap(Thread t) {
    return t.threadLocals;
}
```

é€šè¿‡ä¸Šé¢è¿™äº›å†…å®¹ï¼Œæˆ‘ä»¬è¶³ä»¥é€šè¿‡çŒœæµ‹å¾—å‡ºç»“è®ºï¼š**æœ€ç»ˆçš„å˜é‡æ˜¯æ”¾åœ¨äº†å½“å‰çº¿ç¨‹çš„ `ThreadLocalMap` ä¸­ï¼Œå¹¶ä¸æ˜¯å­˜åœ¨ `ThreadLocal` ä¸Šï¼Œ`ThreadLocal` å¯ä»¥ç†è§£ä¸ºåªæ˜¯`ThreadLocalMap`çš„å°è£…ï¼Œä¼ é€’äº†å˜é‡å€¼ã€‚** `ThrealLocal` ç±»ä¸­å¯ä»¥é€šè¿‡`Thread.currentThread()`è·å–åˆ°å½“å‰çº¿ç¨‹å¯¹è±¡åï¼Œç›´æ¥é€šè¿‡`getMap(Thread t)`å¯ä»¥è®¿é—®åˆ°è¯¥çº¿ç¨‹çš„`ThreadLocalMap`å¯¹è±¡ã€‚

**æ¯ä¸ª`Thread`ä¸­éƒ½å…·å¤‡ä¸€ä¸ª`ThreadLocalMap`ï¼Œè€Œ`ThreadLocalMap`å¯ä»¥å­˜å‚¨ä»¥`ThreadLocal`ä¸º key ï¼ŒObject å¯¹è±¡ä¸º value çš„é”®å€¼å¯¹ã€‚**

```java
ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {
    //......
}
```

æ¯”å¦‚æˆ‘ä»¬åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å£°æ˜äº†ä¸¤ä¸ª `ThreadLocal` å¯¹è±¡çš„è¯ï¼Œ `Thread`å†…éƒ¨éƒ½æ˜¯ä½¿ç”¨ä»…æœ‰çš„é‚£ä¸ª`ThreadLocalMap` å­˜æ”¾æ•°æ®çš„ï¼Œ`ThreadLocalMap`çš„ key å°±æ˜¯ `ThreadLocal`å¯¹è±¡ï¼Œvalue å°±æ˜¯ `ThreadLocal` å¯¹è±¡è°ƒç”¨`set`æ–¹æ³•è®¾ç½®çš„å€¼ã€‚

![ThreadLocalæ•°æ®ç»“æ„](https://javaguide.cn/assets/threadlocal%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.a0bfadf8.png)

`ThreadLocalMap`æ˜¯`ThreadLocal`çš„é™æ€å†…éƒ¨ç±»ã€‚

![ThreadLocalå†…éƒ¨ç±»](https://javaguide.cn/assets/ThreadLocal%E5%86%85%E9%83%A8%E7%B1%BB.fc4bb676.png)

### [#](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#_3-4-threadlocal-å†…å­˜æ³„éœ²é—®é¢˜)3.4. ThreadLocal å†…å­˜æ³„éœ²é—®é¢˜

`ThreadLocalMap` ä¸­ä½¿ç”¨çš„ key ä¸º `ThreadLocal` çš„å¼±å¼•ç”¨,è€Œ value æ˜¯å¼ºå¼•ç”¨ã€‚æ‰€ä»¥ï¼Œå¦‚æœ `ThreadLocal` æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œkey ä¼šè¢«æ¸…ç†æ‰ï¼Œè€Œ value ä¸ä¼šè¢«æ¸…ç†æ‰ã€‚è¿™æ ·ä¸€æ¥ï¼Œ`ThreadLocalMap` ä¸­å°±ä¼šå‡ºç° key ä¸º null çš„ Entryã€‚å‡å¦‚æˆ‘ä»¬ä¸åšä»»ä½•æªæ–½çš„è¯ï¼Œvalue æ°¸è¿œæ— æ³•è¢« GC å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯èƒ½ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚ThreadLocalMap å®ç°ä¸­å·²ç»è€ƒè™‘äº†è¿™ç§æƒ…å†µï¼Œåœ¨è°ƒç”¨ `set()`ã€`get()`ã€`remove()` æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ¸…ç†æ‰ key ä¸º null çš„è®°å½•ã€‚ä½¿ç”¨å®Œ `ThreadLocal`æ–¹æ³•å æœ€å¥½æ‰‹åŠ¨è°ƒç”¨`remove()`æ–¹æ³•

```java
static class Entry extends WeakReference<ThreadLocal<?>> {
    /** The value associated with this ThreadLocal. */
    Object value;

    Entry(ThreadLocal<?> k, Object v) {
        super(k);
        value = v;
    }
}
```

**å¼±å¼•ç”¨ä»‹ç»ï¼š**

> å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰å¼±å¼•ç”¨ï¼Œé‚£å°±ç±»ä¼¼äº**å¯æœ‰å¯æ— çš„ç”Ÿæ´»ç”¨å“**ã€‚å¼±å¼•ç”¨ä¸è½¯å¼•ç”¨çš„åŒºåˆ«åœ¨äºï¼šåªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ‹¥æœ‰æ›´çŸ­æš‚çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨åƒåœ¾å›æ”¶å™¨çº¿ç¨‹æ‰«æå®ƒ æ‰€ç®¡è¾–çš„å†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦ï¼Œéƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜ã€‚ä¸è¿‡ï¼Œç”±äºåƒåœ¾å›æ”¶å™¨æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§å¾ˆä½çš„çº¿ç¨‹ï¼Œ å› æ­¤ä¸ä¸€å®šä¼šå¾ˆå¿«å‘ç°é‚£äº›åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ã€‚
>
> å¼±å¼•ç”¨å¯ä»¥å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨ï¼Œå¦‚æœå¼±å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼ŒJava è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ªå¼±å¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚
